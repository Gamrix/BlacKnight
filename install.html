

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Installation &mdash; BlacKnight 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="BlacKnight 0.1 documentation" href="index.html"/>
        <link rel="next" title="Reference" href="reference.html"/>
        <link rel="prev" title="System Architecture" href="architecture.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html" class="icon icon-home"> BlacKnight
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">System Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#cloud-software-appliances">Cloud Software Appliances</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#abstractions">Abstractions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#roles">Roles</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#appliance-state">Appliance State</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#diff">Diff</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#implementation">Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#developing-appliances">Developing Appliances</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#puppet">Puppet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#blacknight">BlacKnight</a></li>
<li class="toctree-l2"><a class="reference internal" href="#riakcs">RiakCS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#eucalyptus">Eucalyptus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#development">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="#external-documentation">External Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="reference/client.html"><code class="docutils literal"><span class="pre">blacknight.client</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/specification.html"><code class="docutils literal"><span class="pre">blacknight.specification</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/action.html"><code class="docutils literal"><span class="pre">blacknight.action</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/eucalyptus.html"><code class="docutils literal"><span class="pre">blacknight.eucalyptus</span></code></a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">BlacKnight</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Installation</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/install.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<p>This section describes the installation of BlacKnight as well as that of a test environment based on Eucalyptus. A Puppet manifest is provided in the <code class="docutils literal"><span class="pre">puppet/</span></code> directory to make this process marginally less painful. This manifest is not perfect - installation requires some supervision and, in certain cases, multiple passes. To ensure that all necessary components are installed run Puppet repeatedly until no messages are printed. All development was done on CentOS 6.6 (final) and determining whether BlacKnight will run in another environment is left as an exercise for the reader.</p>
<div class="section" id="puppet">
<h2>Puppet<a class="headerlink" href="#puppet" title="Permalink to this headline">¶</a></h2>
<p>Puppet is a configuration management tool for bootstrapping deployments from a user-specified manifest. Familiarity with puppet is not necessary (you can simply follow the instructions below) but will be helpful for trouble-shooting and required for contributing. It must be present on all hosts in order to be used for the installation.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Run the following commands as root on each host to install Puppet:</p>
<div class="last highlight-shell"><div class="highlight"><pre>yum install rubygems
gem install puppet -v <span class="s1">&#39;3.8.1&#39;</span>
puppet module install computology-packagecloud
puppet module install stankevich-python
puppet module install deric-zookeeper
</pre></div>
</div>
</div>
<p>Configuration of the installation is handled entirely within <code class="docutils literal"><span class="pre">puppet/manifests/site.pp</span></code>. Deployment-wide configuration is managed using global variables which are inherited by all hosts. Each host in the deployment is declared in a <em>node</em> block. This block contains host-specific information (e.g. hostname, &amp;c.) and several <em>include</em> directives. The includes inform puppet of which modules should be applied to the host in question. Any module in <code class="docutils literal"><span class="pre">puppet/modules/</span></code> can be included.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Open <code class="docutils literal"><span class="pre">puppet/manifests/site.pp</span></code> and using the template below as a guide</p>
<blockquote>
<div><ol class="arabic simple">
<li>define a <em>node</em> for each host in the appliance using the template below as a guide.</li>
</ol>
</div></blockquote>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="c1"># puppet/manifests/site.pp</span>

<span class="c1"># Global configuration variables</span>
<span class="vg">$CLOUD_OPTS</span> <span class="o">=</span> <span class="s1">&#39;--db-home=/usr/pgsql-9.1/ --java-home=/usr/lib/jvm/java-1.7.0&#39;</span>
<span class="o">...</span>

<span class="c1"># Node declarations</span>
<span class="n">node</span> <span class="s1">&#39;oz.cs.ucsb.edu&#39;</span> <span class="p">{</span>

    <span class="c1"># Host-specific configuration variables</span>
    <span class="vg">$HWADDR</span> <span class="o">=</span> <span class="s1">&#39;00:26:B9:3D:16:D2&#39;</span>
    <span class="vg">$UUID</span> <span class="o">=</span> <span class="s1">&#39;99bb00f0-df2b-437b-9b35-1399c3be2ab2&#39;</span>
    <span class="vg">$PUBLIC_IP</span> <span class="o">=</span> <span class="s1">&#39;128.111.55.51&#39;</span>
    <span class="vg">$IPADDR</span> <span class="o">=</span> <span class="s1">&#39;10.50.10.51&#39;</span>
    <span class="vg">$HOSTNAME</span> <span class="o">=</span> <span class="s1">&#39;oz.cs.ucsb.edu&#39;</span>

    <span class="c1"># Modules to apply on host</span>
    <span class="kp">include</span> <span class="n">blacknight</span>
    <span class="kp">include</span> <span class="n">riak</span>
    <span class="kp">include</span> <span class="n">eucalyptus</span>
<span class="p">}</span>

<span class="n">node</span> <span class="s1">&#39;objc.cs.ucsb.edu&#39;</span> <span class="p">{</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="blacknight">
<h2>BlacKnight<a class="headerlink" href="#blacknight" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">In <code class="docutils literal"><span class="pre">site.pp</span></code>, add the following line to each host on which BlacKnight should be installed.</p>
<blockquote>
<div><div class="highlight-ruby"><div class="highlight"><pre><span class="kp">include</span> <span class="n">blacknight</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Apply the manifest by running the following commands as root on each host.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span class="nb">cd </span>puppet/
./run_puppet
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Puppet occasionally has trouble creating virtualenvs with pypy. If you see an error along the lines of <code class="docutils literal"><span class="pre">virtualenv-pypy:</span> <span class="pre">command</span> <span class="pre">not</span> <span class="pre">found</span></code>, you will have to create the virtualenv yourself with</p>
<div class="last highlight-shell"><div class="highlight"><pre>virtualenv -p pypy /opt/blacknight
</pre></div>
</div>
</div>
</div>
<div class="section" id="riakcs">
<h2>RiakCS<a class="headerlink" href="#riakcs" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Set the following global configuration variables in <code class="docutils literal"><span class="pre">site.pp</span></code>.</p>
<blockquote>
<div><ul class="simple">
<li><strong>$STANCHION_HOST</strong>: IP address of the host that will run Stanchion (can be any host)</li>
<li><strong>$RIAK_ADMIN_KEY</strong>: admin-key</li>
<li><strong>$RIAK_ADMIN_SECRET</strong>: admin-secret</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Apply the manifest by running the following commands as root on the Stanchion host.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span class="nb">cd </span>puppet/
./run_puppet
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Start RiakCS by running the following commands as root on the Stanchion host.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre>riak start
stanchion start
riak-cs start
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Manually edit the RiakCS configuration file <code class="docutils literal"><span class="pre">/etc/riak-cs/riak-cs.conf</span></code> by changing</p>
<blockquote>
<div><div class="highlight-properties"><div class="highlight"><pre><span class="na">anonymous_user_creation</span> <span class="o">=</span> <span class="s">off</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">anonymous_user_creation</span> <span class="o">=</span> <span class="s">on</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Restart Riak by by running</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre>riak-cs restart
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Create an admin user by running the following command. Use the value of <code class="docutils literal"><span class="pre">$RIAKCS_PORT</span></code> in <code class="docutils literal"><span class="pre">site.pp</span></code> as the port in the URL. The choice of name and email for the admin user are not terribly important.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre>curl -XPOST http://localhost:9090/riak-cs/user <span class="se">\</span>
    -H <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
    -d <span class="s1">&#39;{&quot;email&quot;:&quot;admin@admin.com&quot;, &quot;name&quot;:&quot;admin&quot;}&#39;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">RiakCS should respond with the key and secret of the admin user. Copy these into <code class="docutils literal"><span class="pre">$RIAK_ADMIN_KEY</span></code> and <code class="docutils literal"><span class="pre">$RIAK_ADMIN_SECRET</span></code> respectively in <code class="docutils literal"><span class="pre">site.pp</span></code>.</p>
</li>
<li><p class="first">Repeat step 2 on the remaining hosts.</p>
</li>
<li><p class="first">Restart Riak on the Stanchion host as per step 6.</p>
</li>
<li><p class="first">On the remaining nodes start Riak with the following commands. The nodename of stanchion node is</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre>
</pre></div>
</div>
<p>riak start
riak-cs start
riak-admin cluster join riak&#64;&lt;hostname_of_stanchion_node&gt;
riak-admin plan
riak-admin commit</p>
</div></blockquote>
</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>In the following line of <code class="docutils literal"><span class="pre">/etc/riak/advanced.config</span></code>,</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="p">{</span><span class="n">add_paths</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;/usr/lib64/riak-cs/lib/riak_cs-2.0.1/ebin&quot;</span><span class="p">]},</span>
</pre></div>
</div>
<p class="last">the version string (<em>2.0.1</em> above) must match the installed verson of RiakCS or Riak will not start!</p>
</div>
</div>
<div class="section" id="eucalyptus">
<h2>Eucalyptus<a class="headerlink" href="#eucalyptus" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Set the following global configuration variables in <code class="docutils literal"><span class="pre">site.pp</span></code>. (These all mirror variables in <em>eucalyptus.conf</em>)</p>
<blockquote>
<div><ul class="simple">
<li><strong>$VNET_DNS</strong>: IP address of local DNS server (if applicable)</li>
<li><strong>$VNET_NETMASK</strong>: subnet mask for bridged network</li>
<li><strong>$VNET_PRIVINTERFACE</strong>: name interface to bridged network</li>
<li><strong>$VNET_PUBLICIPS</strong>: available public IP addresses</li>
<li><strong>$VNET_SUBNET</strong>: subnet of bridged network</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Apply the manifest by running the following commands as root on all hosts.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span class="nb">cd </span>puppet/
./run_puppet
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If this is the first time you are configuring this machine you should restart it to bring up the bridge interface.</p>
</div>
<ol class="arabic">
<li><p class="first">Choose one host to be the initial primary head and start the head node components on this host.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span class="c"># on the primary</span>
rm -rf /var/lib/eucalyptus/db/
euca_conf --initialize
service eucalyptus-cloud start
<span class="c"># wait until CLC is up (check /var/log/eucalyptus/cloud-output.log)</span>
service eucalyptus-cc start
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Register components on the primary head.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span class="c"># on the primary</span>
euca_conf --register-service -T user-api -H &lt;primary_ip&gt; -N &lt;primary_hostname&gt;-api
euca_conf --register-cluster -P &lt;partition&gt; -H &lt;primary_ip&gt; -C &lt;primary_hostname&gt;-cc
euca_conf --register-sc -P &lt;partition&gt; -H &lt;primary_ip&gt; -C &lt;primary_hostname&gt;-sc
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Generate admin user credentials.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre>euca_conf --get-credentials admin.zip
unzip admin.zip -d /root/cred/
<span class="nb">source</span> /root/cred/eucarc
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Configure primary head. Any host can be used as the RiakCS endpoint.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span class="c"># block storage</span>
euca-modify-property -p &lt;partition&gt;.storage.blockstoragemanager<span class="o">=</span>overlay

<span class="c"># object storage</span>
euca-modify-property -p objectstorage.providerclient<span class="o">=</span>riakcs
euca-modify-property -p objectstorage.s3provider.s3endpoint<span class="o">=</span>&lt;riakcs_ip&gt;:9090
euca-modify-property -p objectstorage.s3provider.s3accesskey<span class="o">=</span>&lt;riakcs_admin_key&gt;
euca-modify-property -p objectstorage.s3provider.s3secretkey<span class="o">=</span>&lt;riakcs_admin_secret&gt;
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Distribute keys across all hosts.</p>
<blockquote>
<div><ol class="loweralpha">
<li><p class="first">Generate an ssh key on each host.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span class="o">[</span> -e /root/.ssh/id_rsa <span class="o">]</span> <span class="o">||</span> ssh-keygen -t rsa -N <span class="s1">&#39;&#39;</span> -f /root/.ssh/id_rsa
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Add every host&#8217;s key to each other&#8217;s list of authorized hosts.</p>
<blockquote>
<div><div class="highlight-shell"><div class="highlight"><pre><span class="k">for</span> host in hosts<span class="p">;</span> <span class="k">do</span>
    <span class="c"># You will get very good at typing your password...</span>
    cat <span class="k">$(</span>ssh host <span class="s1">&#39;cat /root/.ssh/id_rsa&#39;</span><span class="k">)</span> &gt;&gt; /root/.ssh/authorized_hosts
<span class="k">done</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="development">
<h2>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h2>
<p>BlacKnight comes equipped with a series of utilities for simulated execution as testing on a full scale appliance can be unwieldy. The <strong>zkconf</strong> tool is extremely useful for quickly deploying temporary ZooKeeper ensembles; it can be found at FIXME and the instructions are straightforward. The <code class="xref py py-mod docutils literal"><span class="pre">util</span></code> contains various commands for communicating with a local ZooKeeper server to simulate services. The provided specification (<code class="docutils literal"><span class="pre">test/spec.yaml</span></code>) simply points hooks at blacknight-util to start and stop simulated services.</p>
</div>
<div class="section" id="external-documentation">
<h2>External Documentation<a class="headerlink" href="#external-documentation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://docs.puppetlabs.com/puppet/">Puppet</a></li>
<li><a class="reference external" href="https://www.eucalyptus.com/docs/eucalyptus/4.1.1/index.html">Eucalyptus</a></li>
<li><a class="reference external" href="http://docs.basho.com/riakcs/latest/">RiakCS</a></li>
<li><a class="reference external" href="https://zookeeper.apache.org/doc/r3.5.0-alpha/">ZooKeeper</a></li>
<li><a class="reference external" href="https://kazoo.readthedocs.org/en/latest/">Kazoo</a></li>
</ul>
<p>TODO: Distribute keys for eucalyptus!</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="reference.html" class="btn btn-neutral float-right" title="Reference" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="architecture.html" class="btn btn-neutral" title="System Architecture" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Daniel Kudrow.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>